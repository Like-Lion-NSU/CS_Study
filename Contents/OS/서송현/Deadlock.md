# Deadlock(데드락, 교착상태)

### Deadlock
- 두개 이상의 프로세스나 스레드가 서로 자원을 얻지 못해서 다음 처리를 하지 못하는 상태
- 무난히 다음 자원을 기다리게 되는 상태
- 한정된 자원을 여러곳에서 사용할 때 발생

#### 데드락이 일어나는 경우
<img src="OS/pic/deadlock.jpg" width="500">

프로세스1과 2가 자원1,2를 모두 얻어야 한다고 가정
- t1: 프로세스1이 자원1을 얻음/ 프로세스2가 자원2를 얻음
- t2: 프로세스1은 자원2를 기다림/ 프로세스2는 자원1을 기다림

서로 원하는 자원이 상대방에 할당되어 있어서 두 프로세스는 무한정 wait에 빠짐 => Deadlock

#### 데드락이 발생하는 경우
- 멀티 프로그래밍 환경에서 한정된 자원을 얻기위해 서로 경쟁할 때
- 한 프로세스가 자원을 요청했을 때, 동시에 그 자원을 사용할 수 없는 상황 발생 -> 대기 상태로 들어감
- 대기 상태로 들어간 프로세스들이 실행 상태로 변경될 수 없을 때 '교착상태' 발생

### 데드락 발생 조건
>4가지 모두 성립해야 데드락 발생, 하나라도 만족하지 않으면 절대 발생하지 않는다
1. 상호 배제(Multual exclusion)  
   : 자원을 한번에 한 프로세스만 사용할 수 있음
2. 점유 대기(Hold and Wait)   
   : 최소한 하나의 자원을 점유하고 있으면서 다른 프로세스에 할당되어 사용하고 있는 자원을 추가로 점유하기 위해 대기하는 프로세스 존재
3. 비선점(No Preemption)  
   : 다른 프로세스에 할당된 자원을 사용시 끝날때까지 강제로 빼앗을 수 없음
4. 순환대기(Circular wait)  
   : 프로세스의 집합에서 순환 형태로 자원을 대기하고 있어야 함  
   프로세스가 p0. p1, p2, ..., pn까지 있을때
   > p0은 p1이 가진 자원을 기다리고,  
   p1은 p2가 가진 자원을 기다리고,   
   Pn-1은 Pn이 가진 자원을 기다리고,  
   Pn은 p0이 가진 자원을 기다림

### Deadlock 처리 방법
>사전에 교착 상태가 발생하지 않도록 조치하거나 발생한 뒤에 고정
#### 교착상태 예방 및 회피
1. 예방(Prevention)
    - 자원을 할당할 때, 교착상태 조건 중 하나를 제거하면서 해결 => 자원 낭비 심함
    - 사전에 교착상태가 발생하지 않도록 조치
        - 상호배제 부정 : 여러 프로세스가 공유 자원 사용
        - 점유대기 부정 : 프로세스 실행 전 모든 자원 할당
        - 비선점 부정 : 자원 점유 중인 프로세스가 다른 자원을 요청할 때 가진 자원 반납
        - 순환대기 부정 : 자원에 고유번호 할당 후 순서대로 자원 요구
2. 회피(Avoidance)
    - 리소스 할당 측면에서, 교착 상태가 발생할 가능성이 있는 자원일 경우에는 할당하지 않음 (대표적으로 은행원 알고리즘, 자원 할당 그래프가 있음)
    - 시스템 state가 원래 state로 돌아올 수 있는 경우에만 자원 할당(CPU, memory)
    - 자원 당 인스턴스 1개 : 자원 할당 그래프 알고리즘
    - 자원 당 인스턴스 여러개 : 은행원 알고리즘
> 데드락을 막을 수 있지만, 데드락을 생각해서 제약조건을 많이 달면 비효율적임

### 교착 상태를 탐지 및 회복
> 교착 상태가 되도록 허락한 다음 회복 시키는 방법
1. 탐지(Detection)
    - 자원 할당 그래프를 통해 교착 상태 탐지
    - 자원 요청시, 탐지 알고리즘 실행시켜 그에대한 오버헤드 발생

2. 회복(Recovery)
    - 교착 상태 일으킨 프로세스를 종료하거나, 할당된 자원을 해결시켜 회복시키는 바법

#### 프로세스 종료 방법
- 교착 상태의 프로세스를 모두 중지
- 교착 상태가 제거될 때까지 하나씩 프로세스 중지

#### 자원 선점 방법
- 교착 상태의 프로세스가 점유하고 있는 자원을 선점해 다른 프로세스에게 할당(해당 프로세스 일시정지 시킴)
- 우선 순위가 낮은 프로세스나 수행 횟수가 적은 프로세스 위주로 프로세스 자원 선점
  > Deadlock 발생은 허용하고 그에 대한 detection 루틴을 두어 deadlock 발견시 recover

